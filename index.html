<!doctype html>
<html>
    <head>
        <title>Socket.IO chat</title>
        <style>
         * { margin: 0; padding: 0; box-sizing: border-box; }
         body { font: 13px Helvetica, Arial; }
         .disp { dispay: blok;}
         .no-disp {display: none;}
         .text-center {
             display: inline-block;
             width: 100%;
             text-align: center;}
         .center {
             display: block;
             margin-left: auto;
             margin-right: auto;
         }

         .loading {
             display: table-cell;
             text-align: center;
             vertical-align: middle;
         }
        </style>

        <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/materialize/1.0.0-beta/css/materialize.min.css">


    </head>
    <body>

        <nav>
            <div class="nav-wrapper">
                <a href="" class="brand-logo">じゃける</a>
                <ul class="right hide-on-med-and-down">
                    <li><a class="waves-effect waves-light btn-large modal-trigger" href="#modal_ru" id="jakeru">じぇけるぞ!</a></li>
                    

                </ul>
            </div>
        </nav>

        <!-- 初期画面 -->
        <div id="init" class="container">
            <div class="row">
                <div class="col s12">
                    <span class="flow-text text-center">
                        直感を信じよ!
                    </span>
                </div>
            </div>

            <div class="row">
                <div class="col s12">
                    <img src="./images/janken.png" class="center" width="300px" height="300px"/>
                </div>
            </div>
        </div>

        <!-- ユーザーリスト & ゲームスタート -->
        <div id="user_list" class="container no-disp">
            <div class="row">
                <div class="col s12">
                    <a class="waves-effect waves-light btn-large text-center disabled" id="game_start">みんなでじゃける!</a>
                </div>
            </div>
            <div class="row">
                <div class="col s12">

                    <h4>ぷれいやー</h4>
                    <ul class="collection with-header" id="player">
                        
                    </ul>
                </div>
            </div>

        </div>


        <!-- じゃんけんカード -->

        <div id="card" class="container no-disp">
            <div class="row center">
                <div class="col s4">
                    <img alt="1" src="./images/goo.png" class="janken"/>
                </div>

                <div class="col s4">
                    <img alt="2" src="./images/choki.png" class="janken"/>

                </div>

                <div class="col s4">
                    <img alt="3" src="./images/par.png" class="janken"/>
                </div>
            </div>

        </div>


        <div id="processing" class="container no-disp">
            <br>
            <br>
            <br>
            <br>
            <br>
            <br>
            <br>
            <br>
            <br>
            <div class="row center">
                <div class="col s4">
                    <img alt="" src="./images/loading.gif"/>
                </div>
                <div class="col s4">
                    <img alt="" src="./images/loading.gif"/>
                </div>
                <div class="col s4">
                    <img alt="" src="./images/loading.gif"/>
                </div>
            </div>
            <div class="row center">
                <div class="col s12">
                    <p style="font-size: 30px">集計中...</p>
                </div>
            </div>
        </div>

        <div id="result" class="no-disp">
            <br>
            <br>
            <br>
            <br>
            <br>
            <br>
            <br>
            <br>
            <br>
            <div class="row center">
                <div class="col s12">
                    <a class="waves-effect waves-light btn-large modal-trigger" href="#modal-result" id="result">けっかを見る</a>
                </div>
            </div>
        </div>

        <!-- モーダル -->
        <!-- ルーム選択 & ユーザ名定義-->

        <div id="modal_ru" class="modal">
            <div class="modal-content">
                <div class="row">
                    <div class="col s12">
                        <p class="flow-text">ルームを選択してください <br/>
                            <small>※対決したい人と同じルーム名を入力してください</small>
                            <div class="input-field inline">
                                <input id="room_name" type="text" class="validate">
                                <label for="room_name_inline">ルーム名</label>
                                <span class="helper-text" data-error="wrong" data-success="right"></span>
                            </div>
                    </div>
                </div>
                <div class="row">
                    <div class="col s12">
                        <p class="flow-text">ユーザー名を入力してください
                            <div class="input-field inline">
                                <input id="user_name" type="text" class="validate" >
                                <label for="user_name_inline">ユーザー名</label>
                                <span class="helper-text" data-error="wrong" data-success="right"></span>
                            </div>
                    </div>
                </div>
            </div>
            <div class="modal-footer">
                <a href="#!" class="modal-close waves-effect waves-green btn-flat">やっぱりやらない</a>
                <a id="selected_ru" href="#!" class="modal-close waves-effect waves-green btn-flat">けってい</a>
            </div>
        </div>

        <!-- 結果モーダル -->

        <div id="modal-result" class="modal">
            <div class="modal-content">
                <div class="row center">
                    <div class="col s12">
                        <img alt="" src="" id="result-image" width="300px" height="300px"/>
                    </div>
                </div>
            </div>
            <div class="row center">
                <div class="col s12">
                    <a class="waves-effect waves-light btn-large" id="reload">じゃけおわり</a>
                </div>
            </div>
        </div>

        
        <script src="/socket.io/socket.io.js"></script>
        <script src="https://code.jquery.com/jquery-1.11.1.js"></script>
        <script src="https://cdnjs.cloudflare.com/ajax/libs/materialize/1.0.0-beta/js/materialize.min.js"></script>
        <script>
         $(function () {

             var userName = "";
             var roomName = "";

             $('.modal').modal();
             $('.modal-result').modal();


             var keyDictionary = {
                 'Backspace': function(text){
                     return text.substr(0,text.length - 1);
                 }
             };

             
             var socket = io();

             // 画面アクション系

             $("#selected_ru").click(function() {
                 roomName = $('#room_name').val();
                 userName = $('#user_name').val();
                 socket.emit('join room', {'roomName': roomName, "userName": userName});
                 
             })

             $("#game_start").click(function() {
                 socket.emit('start', {'roomName':roomName});
             })

             $(".janken").click(function() {
                 $('#card').hide();
                 $('#processing').removeClass('no-disp');

                 selected = $(this).attr('alt');
                 console.log(selected);
                 socket.emit('selected',{'roomName': roomName, "userName": userName, 'selected': selected})
                 return;
             });

             $("#reload").click(function() {
                 location.reload();
             });
             

             // 通信系

             socket.on('joined', (info) => {
                 $('#init').hide();
                 $('#jakeru').addClass('disabled');
                 
                 $('#user_list').removeClass('no-disp');
                 $('#player').empty();

                 console.log(info);
                 for(user in info.users) {
                     $('#player').append('<li class="collection-item play_num">'+ user  +'</li>');
                 }
                 if($('.play_num').length > 1) {
                     $('#game_start').removeClass('disabled');
                 } else {
                     $('#game_start').addClass('disabled');
                 }
             });

             socket.on('start', (res) =>{
                 $('#user_list').hide();
                 $('#card').removeClass('no-disp');
             });
             

             socket.on('end', (res) => {
                 $('#processing').hide();
                 $('#result').removeClass('no-disp');

                 if (res.winners.includes(userName)) {
                     $('#result-image').attr('src', "./images/win.png");
                 } else {
                     $('#result-image').attr('src', "./images/lose.png");
                 }
             });

             socket.on('draw', (res) => {
                 $('#processing').hide();
                 $('#result').removeClass('no-disp');
                 $('#result-image').attr('src', "./images/draw.png");
             });

             


             
             
         });
        </script>
    </body>
</html>
